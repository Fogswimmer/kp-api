name: Symfony CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Run PHPUnit Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
        ports: [5432:5432]
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: pdo, pdo_pgsql, pgsql

      - name: Set test environment
        run: |
          echo "APP_ENV=test" >> $GITHUB_ENV
          echo "DATABASE_URL=postgresql://test_user:test_pass@postgres:5432/test_db?serverVersion=15&charset=utf8" > .env

      - name: Check Postgres connection
        run: |
          apt-get update && apt-get install -y postgresql-client
          pg_isready -h 127.0.0.1 -p 5432 -U test_user

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-scripts

      - name: Run tests
        run: ./vendor/bin/phpunit --testdox

  symfony-ci:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Deploy via SSH
        uses: D3rHase/ssh-command-action@v0.2.2
        with:
          host: ${{secrets.SSH_HOST}}
          user: ${{secrets.SSH_USER}}
          private_key: ${{secrets.SSH_PRIVATE_KEY}}
          command: |
            cd ${{secrets.PROJECT_FOLDER}};
            git pull;
            cd ..;
            docker compose down --remove-orphans;
            docker compose up -d;
